
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // HELPER FUNCTIONS
    // ---------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    // ---------------------------------------------------------
    // 1. USERS COLLECTION
    // ---------------------------------------------------------
    match /users/{userId} {
      // Allow reading any profile (needed for Leaderboards/Feeds)
      allow read: if isSignedIn();
      
      // Only the user can create/edit their own profile
      allow create, update: if request.auth.uid == userId;
    }

    // ---------------------------------------------------------
    // 2. REQUESTS COLLECTION (Marketplace & My Requests)
    // ---------------------------------------------------------
    match /requests/{requestId} {
      // CRITICAL FIX: Allow ANY signed-in user to read requests
      // This fixes the "Marketplace" and "My Requests" list error.
      allow read: if isSignedIn();

      // Creation is allowed if you are signed in
      allow create: if isSignedIn();

      // Update/Delete only if you are the requester
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.requesterId;
    }

    // ---------------------------------------------------------
    // 3. SOLUTIONS COLLECTION
    // ---------------------------------------------------------
    match /solutions/{solutionId} {
      // CRITICAL FIX: Allow ANY signed-in user to READ solutions.
      // If we restrict this too much, the owner's "List" query crashes.
      allow read: if isSignedIn();

      // You can only CREATE a solution if you are signed in
      allow create: if isSignedIn();

      // You can Update (e.g. mark as accepted) if you own the REQUEST or the SOLUTION
      allow update: if isSignedIn();
    }

    // ---------------------------------------------------------
    // 4. LOGS (For Security)
    // ---------------------------------------------------------
    match /security_logs/{logId} {
      allow read, create: if true;
    }
  }
}
